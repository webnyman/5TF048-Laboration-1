@model PracticeSummary
@using PracticeLogger.Models
@{
    ViewData["Title"] = "Summering";
    var filter = ViewBag.Filter as string;
}

<div class="d-flex justify-content-between align-items-center">
    <h2>Summering</h2>
    <div class="btn-group">
        <a asp-action="Start" class="btn btn-outline-secondary">⬅️ Till loggen</a>
        <a asp-action="Create" class="btn btn-primary">➕ Lägg till pass</a>
    </div>
</div>

@{
    ViewData["Title"] = "Övningssummering";
    var selectedInstrumentId = Context.Request.Query["instrumentId"].ToString();
    var from = Context.Request.Query["from"].ToString();
    var to = Context.Request.Query["to"].ToString();
}

<h2>@ViewData["Title"]</h2>

<form method="get" asp-action="Summary" class="row g-3 align-items-end mb-4">
    <div class="col-md-4">
        <label for="instrumentId" class="form-label">Instrument</label>
        <select id="instrumentId" name="instrumentId" class="form-select" asp-items="ViewBag.Instruments">
            <option value="">(Alla instrument)</option>
        </select>
    </div>

    <div class="col-md-3">
        <label for="from" class="form-label">Från</label>
        <input type="date" id="from" name="from" class="form-control" value="@from" />
    </div>

    <div class="col-md-3">
        <label for="to" class="form-label">Till</label>
        <input type="date" id="to" name="to" class="form-control" value="@to" />
    </div>

    <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filtrera</button>
    </div>
</form>


@if (ViewData["Info"] != null)
{
    <div class="alert alert-info mt-3">@ViewData["Info"]</div>
}

<!-- Filter för instrument (GET) -->
<form asp-action="Summary" method="get" class="row g-2 mt-3">
    <div class="col-auto">
        <label for="instrument" class="col-form-label">Filtrera på instrument</label>
    </div>
    <div class="col-auto">
        <input id="instrument" name="instrument" class="form-control"
               value="@(ViewBag.Filter ?? "")" placeholder="t.ex. Trumpet" />
    </div>
    <div class="col-auto">
        <button class="btn btn-outline-primary" type="submit">Filtrera</button>
        <a asp-action="Summary" class="btn btn-outline-secondary">Rensa</a>
    </div>
</form>

@if (Model.TotalMinutes == 0)
{
    <p class="mt-4 text-muted">Inga pass hittades för vald filtrering.</p>
}
else
{
    <!-- Cards med totalsiffror -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted">Totalt antal minuter</h6>
                    <div class="display-6">@Model.TotalMinutes</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted">Snitt per aktiv dag</h6>
                    <div class="display-6">@Model.AvgPerDay</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted">Aktiva dagar</h6>
                    <div class="display-6">@Model.DistinctActiveDays</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted">Antal pass</h6>
                    <div class="display-6">@Model.EntriesCount</div>
                </div>
            </div>
        </div>
    </div>

    @if (ViewBag.Filter != null)
    {
        <p><span class="badge bg-info text-dark">Aktivt filter: @ViewBag.Filter</span></p>
    }

    <!-- Tabell: minuter per instrument -->
    <h4 class="mt-3">Minuter per instrument</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Instrument</th>
                <th>Minuter</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var kv in Model.MinutesPerInstrument)
            {
                <tr>
                    <td>@kv.Key</td>
                    <td>@kv.Value</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Tabell: minuter per intensitet -->
    <h4 class="mt-4">Minuter per intensitet (1–5)</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Intensitet</th>
                <th>Minuter</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var kv in Model.MinutesPerIntensity)
            {
                <tr>
                    <td>@kv.Key</td>
                    <td>@kv.Value</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- NY: Tabell minuter per passtyp -->
    @if (Model.MinutesPerPracticeType != null && Model.MinutesPerPracticeType.Any())
    {
        <h4 class="mt-4">Minuter per passtyp</h4>
        <table class="table table-striped">
            <thead>
                <tr><th>Passtyp</th><th>Minuter</th></tr>
            </thead>
            <tbody>
                @foreach (var kv in Model.MinutesPerPracticeType.OrderBy(k => k.Key))
                {
                    var label = Enum.IsDefined(typeof(PracticeType), (byte)kv.Key)
                    ? ((PracticeType)kv.Key).Label()
                    : $"Typ {kv.Key}";
                    <tr><td>@label</td><td>@kv.Value</td></tr>
                }
            </tbody>
        </table>
    }

    <!-- NY: Tempo-statistik -->
    @if (Model.PassWithTempo > 0)
    {
        <h4 class="mt-4">Tempo</h4>
        <table class="table table-striped w-auto">
            <thead>
                <tr><th>Pass med tempo</th><th>Snitt förbättring (bpm)</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td>@Model.PassWithTempo</td>
                    <td>@(Model.AvgTempoDelta?.ToString("0.0") ?? "-")</td>
                </tr>
            </tbody>
        </table>
    }

    <!-- NY: Mood/Energy -->
    @if (Model.AvgMood.HasValue || Model.AvgEnergy.HasValue)
    {
        <h4 class="mt-4">Känslotillstånd</h4>
        <table class="table table-striped w-auto">
            <thead>
                <tr><th>Snitt humör (1–5)</th><th>Snitt energi (1–5)</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td>@(Model.AvgMood?.ToString("0.0") ?? "-")</td>
                    <td>@(Model.AvgEnergy?.ToString("0.0") ?? "-")</td>
                </tr>
            </tbody>
        </table>
    }
}
